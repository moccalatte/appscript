<!DOCTYPE html>
<html lang="id" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
    <title>ğŸ“’ Suki Finance Tracker</title>
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:wght@400;700&display=swap" rel="stylesheet" />
    <style>
      :root {
        --bg: #fafafa;
        --text: #111;
        --card: #fff;
        --border: #000;
        --shadow: 4px 4px 0 #000;
        --accent1: #ffd54f; /* yellow */
        --accent2: #4dd0e1; /* teal */
        --accent3: #aed581; /* green */
        --accent4: #ff8a65; /* orange */
        --accent5: #ba68c8; /* purple */
        --accent6: #90caf9; /* blue */
      }
      [data-theme="dark"] {
        --bg: #121212;
        --text: #f5f5f5;
        --card: #1e1e1e;
        --border: #f5f5f5;
        --shadow: 4px 4px 0 #555;
      }

      * { box-sizing: border-box; }
      html, body { height: 100%; }
      body {
        margin: 0;
        font-family: "Bricolage Grotesque", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
        background: var(--bg);
        color: var(--text);
      }

      .container {
        max-width: 980px;
        margin: 0 auto;
        padding: 16px;
      }

      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 16px;
      }

      .title {
        display: inline-flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        border: 4px solid var(--border);
        background: var(--accent2);
        box-shadow: var(--shadow);
        border-radius: 12px;
        font-weight: 700;
      }

      .toolbar {
        display: inline-flex;
        gap: 8px;
        align-items: center;
      }

      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        border: 4px solid var(--border);
        background: var(--card);
        box-shadow: var(--shadow);
        padding: 10px 14px;
        border-radius: 12px;
        font-weight: 700;
        cursor: pointer;
        transition: transform 0.05s ease-in-out;
        text-decoration: none;
        color: inherit;
      }
      .btn:active {
        transform: translate(2px, 2px);
        box-shadow: 2px 2px 0 var(--border);
      }
      .btn.primary { background: var(--accent6); }
      .btn.secondary { background: var(--accent4); }
      .btn.ghost { background: var(--card); }
      .btn.sheet-link {
        background: #2e7d32;
        color: #fff;
        border-color: #1b5e20;
      }
      .btn.sheet-link:active {
        box-shadow: 2px 2px 0 #1b5e20;
      }

      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }
      @media (max-width: 720px) {
        .grid { grid-template-columns: 1fr; }
        header { flex-direction: column; align-items: flex-start; }
      }

      .card {
        background: var(--card);
        border: 4px solid var(--border);
        box-shadow: var(--shadow);
        border-radius: 16px;
        padding: 16px;
      }

      .input-area textarea {
        width: 100%;
        min-height: 110px;
        padding: 12px;
        border: 4px solid var(--border);
        border-radius: 12px;
        background: #fff;
        box-shadow: var(--shadow);
        font-size: 16px;
      }
      .input-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 10px;
      }
      .receipt-actions {
        align-items: center;
        gap: 12px;
      }
      .upload-status {
        font-size: 13px;
        font-weight: 600;
        color: var(--text);
        opacity: 0.8;
      }

      .summary {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }
      @media (max-width: 640px) {
        .summary { grid-template-columns: 1fr; }
      }
      .summary .stat {
        padding: 12px;
        border: 4px solid var(--border);
        border-radius: 12px;
        box-shadow: var(--shadow);
        background: var(--card);
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-weight: 700;
      }
      .summary .stat.saldo { background: var(--accent1); }
      .summary .stat.masukBulan { background: var(--accent3); }
      .summary .stat.keluarBulan { background: var(--accent4); }
      .summary .stat.totalHari { background: var(--accent2); }
      .summary .sheet-actions {
        grid-column: 1 / -1;
        display: flex;
        flex-direction: column;
        gap: 8px;
        background: transparent;
        padding: 0;
        border: none;
        box-shadow: none;
      }
      .summary .sheet-note {
        margin: 0;
        font-size: 13px;
        color: var(--text);
        opacity: 0.75;
      }

      .filter-bar {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
        margin-bottom: 8px;
      }
      .filter-bar select {
        border: 4px solid var(--border);
        border-radius: 12px;
        box-shadow: var(--shadow);
        padding: 8px 12px;
        background: #fff;
        font-weight: 700;
      }

      .list {
        margin-top: 8px;
      }
      .list-item {
        display: grid;
        grid-template-columns: 48px 1fr auto;
        gap: 12px;
        align-items: center;
        padding: 10px;
        border: 4px solid var(--border);
        border-radius: 12px;
        box-shadow: var(--shadow);
        background: var(--card);
        margin-bottom: 8px;
      }
      .list-item .emoji {
        font-size: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 4px solid var(--border);
        border-radius: 10px;
        background: #fff;
        box-shadow: var(--shadow);
      }
      .list-item .meta {
        display: flex;
        flex-direction: column;
        gap: 4px;
        font-size: 14px;
      }
      .list-item .amt {
        font-weight: 800;
        font-size: 16px;
      }

      footer {
        margin: 20px 0 40px;
        text-align: center;
        font-size: 12px;
        opacity: 0.9;
      }

      .toast {
        position: fixed;
        bottom: 18px;
        right: 18px;
        z-index: 9999;
        display: none;
        padding: 12px 16px;
        border-radius: 12px;
        border: 4px solid var(--border);
        box-shadow: var(--shadow);
        background: #fff;
        font-weight: 700;
      }
      .toast.success { background: #c6efce; color: #006100; }
      .toast.error { background: #f8cecc; color: #9c0006; }
      .toast.processing { background: #fff3cd; color: #7a5d00; }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <div class="title">ğŸ“’ Suki Finance Tracker</div>
        <div class="toolbar">
          <button id="themeToggle" class="btn ghost" title="Toggle Tema">ğŸŒ™ / â˜€ï¸</button>
          <button id="refreshBtn" class="btn ghost" title="Refresh">ğŸ”„ Refresh</button>
        </div>
      </header>

      <div class="grid">
        <section class="card input-area">
          <h3 style="margin-top:0">ğŸ“ Input Teks Natural</h3>
          <p style="margin-top:0;margin-bottom:8px">
            Contoh: <strong>keluar kopi 16rb, sabun 10rb</strong> atau <strong>masuk gaji 10jt</strong>
          </p>
          <textarea id="rawText" placeholder="Tulis di sini..."></textarea>
          <div class="input-actions">
            <button id="btnKeluar" class="btn secondary">ğŸ’¸ Catat Pengeluaran</button>
            <button id="btnMasuk" class="btn primary">ğŸ’° Catat Pemasukan</button>
            <button id="btnClear" class="btn ghost">ğŸ§½ Clear</button>
          </div>
          <hr style="border:0;border-top:2px dashed var(--border);margin:18px 0" />
          <h3 style="margin-top:0">ğŸ“· Upload Struk</h3>
          <p style="margin-top:0;margin-bottom:8px">
            Foto struk akan diperkecil &amp; dibaca otomatis, lalu setiap produk bakal masuk ke sheet sebagai baris terpisah.
          </p>
          <div class="input-actions receipt-actions">
            <button id="btnUploadKeluar" class="btn secondary">ğŸ“¸ Struk Pengeluaran</button>
            <button id="btnUploadMasuk" class="btn primary">ğŸ“¸ Struk Pemasukan</button>
            <span id="receiptStatus" class="upload-status" style="display:none">Sedang memprosesâ€¦</span>
          </div>
          <p style="margin:8px 0 0;font-size:13px;opacity:0.75">
            Tips: foto tegak lurus, pastikan teks terbaca. File &lt; 8MB akan otomatis diperkecil ke 1200px.
          </p>
        </section>

        <section class="card">
          <h3 style="margin-top:0">ğŸ“Š Ringkasan</h3>
          <div class="summary">
            <div class="stat saldo">
              <span>Saldo Berjalan</span>
              <span id="saldoBerjalan">Rp 0</span>
            </div>
            <div class="stat masukBulan">
              <span>Pemasukan Bulan Ini</span>
              <span id="pemasukanBulanIni">Rp 0</span>
            </div>
            <div class="stat keluarBulan">
              <span>Pengeluaran Bulan Ini</span>
              <span id="pengeluaranBulanIni">Rp 0</span>
            </div>
            <div class="stat totalHari">
              <span>Total Hari Ini</span>
              <span id="totalHariIni">Rp 0</span>
            </div>
            <div class="sheet-actions">
              <p class="sheet-note">Butuh akses data lengkap? Kamu bisa buka Google Sheet utama kami.</p>
              <a class="btn sheet-link" href="https://docs.google.com/spreadsheets/d/1LnkXgFHzL9nhVO9Sz0vgEEucuV3J8F2c-o36JoCSc6o/" target="_blank" rel="noopener">
                ğŸ“„ Buka Google Sheet
              </a>
            </div>
          </div>
        </section>
      </div>

      <section class="card">
        <h3 style="margin-top:0">ğŸ“‹ Daftar Transaksi (5 terakhir)</h3>

        <div class="filter-bar">
          <label for="category">ğŸ” Filter Kategori:</label>
          <select id="category">
            <option value="">Semua</option>
            <option value="Makanan & Minuman">ğŸ” Makanan & Minuman</option>
            <option value="Kebersihan">ğŸ§´ Kebersihan</option>
            <option value="Transport">ğŸšŒ Transport</option>
            <option value="Pakaian">ğŸ‘• Pakaian</option>
            <option value="Tagihan">âš¡ Tagihan</option>
            <option value="Hiburan">ğŸ® Hiburan</option>
            <option value="Lainnya">ğŸ² Lainnya</option>
          </select>
          <button id="applyFilter" class="btn ghost">Terapkan</button>
        </div>

        <div id="list" class="list"></div>
      </section>

      <footer>
        Â© Suki Finance Â· v1 Â· Neobrutalism UI Â· Waktu (Asia/Jakarta): <span id="footerTime">--</span>
      </footer>
    </div>

    <input type="file" id="receiptInput" accept="image/*" style="display:none" />
    <div id="processingToast" class="toast processing"></div>
    <div id="toast" class="toast"></div>

      <script>
        // Theme toggle with persistence
        (function initTheme() {
          const saved = localStorage.getItem('theme') || 'light';
          document.documentElement.setAttribute('data-theme', saved);
        })();

        function toggleTheme() {
          const cur = document.documentElement.getAttribute('data-theme') || 'light';
          const next = cur === 'light' ? 'dark' : 'light';
          document.documentElement.setAttribute('data-theme', next);
          localStorage.setItem('theme', next);
        }

        function updateFooterTime() {
          const el = document.getElementById('footerTime');
          if (!el) return;
          try {
            const now = new Date();
            const parts = new Intl.DateTimeFormat('en-GB', {
              timeZone: 'Asia/Jakarta',
              year: 'numeric',
              month: '2-digit',
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit',
              hour12: false
            }).formatToParts(now);
            const bag = {};
            for (const part of parts) {
              if (part.type !== 'literal') {
                bag[part.type] = part.value;
              }
            }
            const day = bag.day || '00';
            const month = bag.month || '00';
            const year = bag.year || '0000';
            const hour = bag.hour || '00';
            const minute = bag.minute || '00';
            el.textContent = `${day}-${month}-${year} ${hour}:${minute}`;
          } catch (err) {
            el.textContent = 'Asia/Jakarta';
          }
        }

        updateFooterTime();
        setInterval(updateFooterTime, 60 * 1000);

        // Daily randomized accents for freshness (optional)
        (function randomizeAccents() {
          try {
            const now = new Date();
            // Seed by day-of-year
          const start = new Date(now.getFullYear(), 0, 0);
          const diff = now - start;
          const day = Math.floor(diff / (1000 * 60 * 60 * 24));
          const hue = (day * 37) % 360;
          const root = document.documentElement;
          root.style.setProperty('--accent1', `hsl(${hue}, 95%, 65%)`);
          root.style.setProperty('--accent2', `hsl(${(hue+40)%360}, 95%, 70%)`);
          root.style.setProperty('--accent3', `hsl(${(hue+80)%360}, 85%, 72%)`);
          root.style.setProperty('--accent4', `hsl(${(hue+160)%360}, 85%, 70%)`);
          root.style.setProperty('--accent5', `hsl(${(hue+220)%360}, 85%, 74%)`);
          root.style.setProperty('--accent6', `hsl(${(hue+280)%360}, 85%, 76%)`);
        } catch (e) {}
      })();

      // Utilities
      function showProcessing(msg) {
        const el = document.getElementById('processingToast');
        if (!el) return;
        el.textContent = msg || 'Sedang memproses...';
        el.style.display = 'block';
      }

      function hideProcessing() {
        const el = document.getElementById('processingToast');
        if (!el) return;
        el.style.display = 'none';
      }

      function showToast(type, msg) {
        hideProcessing();
        const el = document.getElementById('toast');
        el.className = 'toast ' + (type || 'success');
        el.textContent = msg;
        el.style.display = 'block';
        setTimeout(() => { el.style.display = 'none'; }, 2000);
      }

      function formatRupiah(n) {
        try {
          const v = Number(n || 0);
          return 'Rp ' + v.toLocaleString('id-ID');
        } catch {
          return 'Rp ' + (n || 0);
        }
      }

      function categoryEmoji(cat, dir) {
        const d = (dir || '').toLowerCase();
        if (d === 'masuk') return 'ğŸ’°';
        if (d === 'keluar') return 'ğŸ’¸';
        const c = (cat || '').toLowerCase();
        if (c.includes('makanan')) return 'ğŸ”';
        if (c.includes('kebersihan')) return 'ğŸ§´';
        if (c.includes('transport')) return 'ğŸšŒ';
        if (c.includes('pakaian')) return 'ğŸ‘•';
        if (c.includes('tagihan')) return 'âš¡';
        if (c.includes('hiburan')) return 'ğŸ®';
        return 'ğŸ²';
      }

      // Backend calls via google.script.run

      function refreshSummary() {
        if (!google || !google.script || !google.script.run) return;
        google.script.run
          .withSuccessHandler((res) => {
            if (!res || !res.ok) return;
            document.getElementById('saldoBerjalan').textContent = formatRupiah(res.saldoBerjalan);
            document.getElementById('pemasukanBulanIni').textContent = formatRupiah(res.pemasukanBulanIni);
            document.getElementById('pengeluaranBulanIni').textContent = formatRupiah(res.pengeluaranBulanIni);
            document.getElementById('totalHariIni').textContent = formatRupiah(res.totalHariIni);
          })
          .withFailureHandler((err) => {
            showToast('error', 'Gagal ambil ringkasan');
          })
          .getSummary();
      }

      function refreshList() {
        const category = document.getElementById('category').value || null;
        if (!google || !google.script || !google.script.run) return;
        google.script.run
          .withSuccessHandler((res) => {
            const list = document.getElementById('list');
            list.innerHTML = '';
            const items = (res && res.items) ? res.items.slice(0, 5) : [];
            if (!items.length) {
              list.innerHTML = '<div class="list-item"><div class="emoji">ğŸ“­</div><div class="meta">Belum ada transaksi</div><div class="amt">â€”</div></div>';
              return;
            }
            items.forEach((t) => {
              const itemEl = document.createElement('div');
              itemEl.className = 'list-item';
              const emojiEl = document.createElement('div');
              emojiEl.className = 'emoji';
              emojiEl.textContent = categoryEmoji(t.category, t.direction);
              const metaEl = document.createElement('div');
              metaEl.className = 'meta';
              metaEl.innerHTML =
                '<div><strong>' + (t.item || '-') + '</strong></div>' +
                '<div>' + (t.timestamp || '-') + ' Â· <em>' + (t.category || '-') + '</em> Â· ' + (t.direction || '-') + '</div>';
              const amtEl = document.createElement('div');
              amtEl.className = 'amt';
              amtEl.textContent = formatRupiah(t.amount || 0);
              itemEl.appendChild(emojiEl);
              itemEl.appendChild(metaEl);
              itemEl.appendChild(amtEl);
              list.appendChild(itemEl);
            });
          })
          .withFailureHandler((err) => {
            showToast('error', 'Gagal ambil transaksi');
          })
          .listTransactions(50, category);
      }

      async function resizeImage(file, maxSize) {
        return new Promise((resolve, reject) => {
          const img = new Image();
          const url = URL.createObjectURL(file);
          img.onload = () => {
            try {
              const canvas = document.createElement('canvas');
              const ctx = canvas.getContext('2d');
              const scale = Math.min(1, maxSize / Math.max(img.width, img.height));
              const width = Math.round(img.width * scale);
              const height = Math.round(img.height * scale);
              canvas.width = width;
              canvas.height = height;
              ctx.drawImage(img, 0, 0, width, height);
              canvas.toBlob(
                (blob) => {
                  URL.revokeObjectURL(url);
                  if (!blob) {
                    reject(new Error('Gagal mengubah gambar'));
                    return;
                  }
                  const reader = new FileReader();
                  reader.onloadend = () => {
                    const result = reader.result || '';
                    const parts = String(result).split(',');
                    resolve({
                      base64: parts.length > 1 ? parts[1] : '',
                      mimeType: blob.type || 'image/jpeg',
                    });
                  };
                  reader.onerror = () => reject(new Error('Gagal membaca gambar'));
                  reader.readAsDataURL(blob);
                },
                'image/jpeg',
                0.82
              );
            } catch (err) {
              URL.revokeObjectURL(url);
              reject(err);
            }
          };
          img.onerror = () => {
            URL.revokeObjectURL(url);
            reject(new Error('Gambar tidak bisa dibaca'));
          };
          img.src = url;
        });
      }

      function submit(direction) {
        const ta = document.getElementById('rawText');
        const text = (ta.value || '').trim();
        if (!text) {
          showToast('error', 'Teks kosong');
          ta.focus();
          return;
        }
        showProcessing('Sedang memproses...');
        google.script.run
          .withSuccessHandler((res) => {
            hideProcessing();
            if (res && res.ok) {
              showToast('success', 'Tersimpan (' + (res.count || 0) + ')');
              // Auto-focus + auto-clear input box
              ta.value = '';
              ta.focus();
              refreshSummary();
              refreshList();
            } else {
              hideProcessing();
              showToast('error', 'Gagal simpan');
            }
          })
          .withFailureHandler((err) => {
            hideProcessing();
            showToast('error', 'Error: ' + (err && err.message ? err.message : 'unknown'));
          })
          .recordTransactions(text, direction);
      }

      // Receipt upload helpers
      let pendingReceiptDirection = null;

      function setReceiptStatus(text) {
        const el = document.getElementById('receiptStatus');
        if (!el) return;
        if (text) {
          el.textContent = text;
          el.style.display = 'inline-flex';
        } else {
          el.textContent = '';
          el.style.display = 'none';
        }
      }

      function requestReceiptUpload(direction) {
        const input = document.getElementById('receiptInput');
        pendingReceiptDirection = direction;
        if (!input) {
          showToast('error', 'Input tidak tersedia');
          return;
        }
        input.value = '';
        input.click();
        setReceiptStatus('');
      }

      async function handleReceiptChange(event) {
        const file = event?.target?.files?.[0] || null;
        if (!file) return;
        if (!pendingReceiptDirection) {
          showToast('error', 'Pilih jenis transaksi terlebih dahulu');
          setReceiptStatus('');
          return;
        }
        if (!file.type.startsWith('image/')) {
          showToast('error', 'File harus berupa gambar');
          setReceiptStatus('');
          return;
        }
        if (file.size > 8 * 1024 * 1024) {
          showToast('error', 'Ukuran maks 8MB');
          setReceiptStatus('');
          return;
        }
        try {
          setReceiptStatus('Tunggu bentar ya, lagi aku rapiin fotonyaâ€¦ âœ¨');
          showProcessing('Sebentar, lagi rapiin strukâ€¦');
          const resized = await resizeImage(file, 1200);
          if (!resized.base64) {
            showToast('error', 'Gagal kompres gambar');
            setReceiptStatus('');
            return;
          }
          setReceiptStatus('Sabar ya, lagi kupilah itemnya biar kinclong! ğŸ’ª');
          showProcessing('Lagi baca strukmu, tunggu sebentar yaâ€¦');
          google.script.run
            .withSuccessHandler((res) => {
              hideProcessing();
              pendingReceiptDirection = null;
              if (res && res.ok) {
                setReceiptStatus('');
                showToast('success', 'Struk tersimpan (' + (res.count || 0) + ')');
                refreshSummary();
                refreshList();
              } else {
                setReceiptStatus('');
                showToast('error', (res && res.error) ? res.error : 'Gagal memproses struk');
              }
            })
            .withFailureHandler((err) => {
              hideProcessing();
              pendingReceiptDirection = null;
              setReceiptStatus('');
              showToast('error', 'Error: ' + (err && err.message ? err.message : 'unknown'));
            })
            .processReceiptUpload({
              direction: pendingReceiptDirection,
              imageBase64: resized.base64,
              mimeType: resized.mimeType,
              fileName: file.name || 'receipt.jpg',
              originalSize: file.size,
            });
        } catch (err) {
          hideProcessing();
          pendingReceiptDirection = null;
          setReceiptStatus('');
          showToast('error', err && err.message ? err.message : 'Gagal memproses struk');
        }
      }

      // Wire UI
      document.getElementById('btnKeluar')?.addEventListener('click', () => submit('keluar'));
      document.getElementById('btnMasuk')?.addEventListener('click', () => submit('masuk'));
      document.getElementById('btnClear')?.addEventListener('click', () => { document.getElementById('rawText').value = ''; });
      document.getElementById('applyFilter')?.addEventListener('click', () => refreshList());
      document.getElementById('refreshBtn')?.addEventListener('click', () => { refreshSummary(); refreshList(); });
      document.getElementById('themeToggle')?.addEventListener('click', toggleTheme);
      document.getElementById('btnUploadKeluar')?.addEventListener('click', () => requestReceiptUpload('keluar'));
      document.getElementById('btnUploadMasuk')?.addEventListener('click', () => requestReceiptUpload('masuk'));
      document.getElementById('receiptInput')?.addEventListener('change', handleReceiptChange);

      // Initial load
      refreshSummary();
      refreshList();

      /**
       * Clickable references:
       * - [`function refreshSummary()`](index.html:367)
       * - [`function refreshList()`](index.html:383)
       * - [`function submit()`](index.html:421)
       * - [`index.html`](index.html)
       */
    </script>
  </body>
</html>
